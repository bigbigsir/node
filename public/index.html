<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.0.0-rc.1/bin/jsencrypt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.0.0/crypto-js.min.js"></script>
  <script src="https://cdn.bootcss.com/socket.io/2.3.0/socket.io.js"></script>
</head>
<body>
<img id="img" src="" alt="">
<div id="div"></div>
<button id="button">发送请求</button>
<button id="node">更新node代码</button>
<button id="react">更新react代码</button>
<div>
  <pre id="socket"></pre>
</div>
<br>
<br>
<div>
  <pre id="nodePre"></pre>
</div>
<div>
  <pre id="reactPre"></pre>
</div>
<script>
  const key = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDTacKAITLQ0GC8BJ0Jy/0EkSv1yDTI77rtpO9+99dhRYRyRoAGnzrzZpo+0+i7TQwULxJAN43IvRHstpK/YmGjH4jXTPtTNWhJZR5OJ8e0lUT36WYLLR5f2LxwJZ+ftrUMj719EM6TYz51paTUI7UE3WkPHzPmmjhDXR7L7JBmKwIDAQAB'
  const crypto = new JSEncrypt()
  crypto.setPublicKey(key)
  let token = null
  $('#button').on('click', function () {
    let data = {}
    const token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1OTExMDg0NjMsImlwIjoiMTkyLjE2OC4yNTQuMTA1In0.gcH5tr6Iv_ym6icmhFYLwg5-6mLT2NVDf367y9cnPr4EbgzpkigqLmqQENC8Rok7MunXeRcD6-yK3uBOKpZpeI3UN_y2cnBEZVeJC2NdMbYmy5-fSCZ44nSho-mq6knQ37Vg43OVdKVLu_WTP08THiZ9kT-5tZQN05sgATQAcH4'
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/test',
      headers: {
        token,
        qid,
        sign
      },
      contentType: 'application/json;charset=UTF-8',
      data: data,
      success (data) {
        console.log(data)
      }
    })
  })

  getWebToken()

  function getWebToken () {
    let data = {}
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/common/getWebToken',
      headers: {
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success ({ data }) {
        token = data
        signIn(token)
        // signUp(token)
        getCaptcha(token)
      }
    })
  }

  function getCaptcha (token) {
    let data = {}
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/common/getCaptcha',
      headers: {
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success ({ data }) {
        document.getElementById('div').innerHTML = data.image
        verifyCaptcha(token)
      }
    })
  }

  function verifyCaptcha (token) {
    let data = {
      captchaId: '5ed86d11a0e60b3b69df8620',
      captcha: '12'
    }
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/common/verifyCaptcha',
      headers: {
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success ({ data }) {
      }
    })
  }

  function signIn (token) {
    let data = {
      username: 'admin1',
      password: crypto.encrypt('admin1')
    }
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/users/signIn',
      headers: {
        appId: 'PC01',
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success (data) {
        // signOut()
        // getUserInfo()
        setTimeout(() => getUserInfo(), 4)
      }
    })
  }

  function signUp (token) {
    let data = {
      username: 'admin' + Date.now(),
      password: crypto.encrypt('123456'),
      email: '519628061@qq.com'
    }
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/users/signUp',
      headers: {
        appId: 'PC01',
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success (data) {
        console.log(data)
      }
    })
  }

  function signOut () {
    let data = {
      username: 'admin1591177482319'
    }
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/users/signOut',
      headers: {
        appId: 'PC01',
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success (data) {
      }
    })
  }

  function getUserInfo () {
    // token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1OTExNzQzNzMsImlwIjoiMTkyLjE2OC4yNTQuMTA1In0.O8EXjkgtaHelDlmk8w-8z89-GjzvKc-Z4RWHonFCWExOF8eWxvmmNU_trqXj3d3tW9nYiHah_6TlL2Hu-aBsGEd2ghvrrz4hNGG2m-tCpDtA9EtJMclqzrcj2w6P4xBhyxQSvNxeXITTzPH6hG9DLMQKFDCClSRJGF-CrBtFw4g'
    let data = {
      username: 'admin1591177482319'
    }
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/users/getUserInfo',
      headers: {
        appId: 'PC01',
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success (data) {
        console.log(data)
      }
    })
  }

  function reverseString (string = '') {
    return string.toString().split('').sort().reverse().join('')
  }
</script>
<script>
  const data = {
    'ref': 'refs/heads/master',
    'before': '1b389bb6a9131415dcc02d2fbc941b74fd733cd3',
    'after': 'b6f60c43e9169ccb56350ce5b035c5483761d42c',
    'repository': {
      'id': 166796615,
      'node_id': 'MDEwOlJlcG9zaXRvcnkxNjY3OTY2MTU=',
      'name': 'nodeJs',
      'full_name': 'bigbigsir/nodeJs',
      'private': false,
      'owner': {
        'name': 'bigbigsir',
        'email': '519628061@qq.com',
        'login': 'bigbigsir',
        'id': 30718335,
        'node_id': 'MDQ6VXNlcjMwNzE4MzM1',
        'avatar_url': 'https://avatars0.githubusercontent.com/u/30718335?v=4',
        'gravatar_id': '',
        'url': 'https://api.github.com/users/bigbigsir',
        'html_url': 'https://github.com/bigbigsir',
        'followers_url': 'https://api.github.com/users/bigbigsir/followers',
        'following_url': 'https://api.github.com/users/bigbigsir/following{/other_user}',
        'gists_url': 'https://api.github.com/users/bigbigsir/gists{/gist_id}',
        'starred_url': 'https://api.github.com/users/bigbigsir/starred{/owner}{/repo}',
        'subscriptions_url': 'https://api.github.com/users/bigbigsir/subscriptions',
        'organizations_url': 'https://api.github.com/users/bigbigsir/orgs',
        'repos_url': 'https://api.github.com/users/bigbigsir/repos',
        'events_url': 'https://api.github.com/users/bigbigsir/events{/privacy}',
        'received_events_url': 'https://api.github.com/users/bigbigsir/received_events',
        'type': 'User',
        'site_admin': false
      },
      'html_url': 'https://github.com/bigbigsir/nodeJs',
      'description': 'Node+Express+MongoDB实现的后台服务',
      'fork': false,
      'url': 'https://github.com/bigbigsir/nodeJs',
      'forks_url': 'https://api.github.com/repos/bigbigsir/nodeJs/forks',
      'keys_url': 'https://api.github.com/repos/bigbigsir/nodeJs/keys{/key_id}',
      'collaborators_url': 'https://api.github.com/repos/bigbigsir/nodeJs/collaborators{/collaborator}',
      'teams_url': 'https://api.github.com/repos/bigbigsir/nodeJs/teams',
      'hooks_url': 'https://api.github.com/repos/bigbigsir/nodeJs/hooks',
      'issue_events_url': 'https://api.github.com/repos/bigbigsir/nodeJs/issues/events{/number}',
      'events_url': 'https://api.github.com/repos/bigbigsir/nodeJs/events',
      'assignees_url': 'https://api.github.com/repos/bigbigsir/nodeJs/assignees{/user}',
      'branches_url': 'https://api.github.com/repos/bigbigsir/nodeJs/branches{/branch}',
      'tags_url': 'https://api.github.com/repos/bigbigsir/nodeJs/tags',
      'blobs_url': 'https://api.github.com/repos/bigbigsir/nodeJs/git/blobs{/sha}',
      'git_tags_url': 'https://api.github.com/repos/bigbigsir/nodeJs/git/tags{/sha}',
      'git_refs_url': 'https://api.github.com/repos/bigbigsir/nodeJs/git/refs{/sha}',
      'trees_url': 'https://api.github.com/repos/bigbigsir/nodeJs/git/trees{/sha}',
      'statuses_url': 'https://api.github.com/repos/bigbigsir/nodeJs/statuses/{sha}',
      'languages_url': 'https://api.github.com/repos/bigbigsir/nodeJs/languages',
      'stargazers_url': 'https://api.github.com/repos/bigbigsir/nodeJs/stargazers',
      'contributors_url': 'https://api.github.com/repos/bigbigsir/nodeJs/contributors',
      'subscribers_url': 'https://api.github.com/repos/bigbigsir/nodeJs/subscribers',
      'subscription_url': 'https://api.github.com/repos/bigbigsir/nodeJs/subscription',
      'commits_url': 'https://api.github.com/repos/bigbigsir/nodeJs/commits{/sha}',
      'git_commits_url': 'https://api.github.com/repos/bigbigsir/nodeJs/git/commits{/sha}',
      'comments_url': 'https://api.github.com/repos/bigbigsir/nodeJs/comments{/number}',
      'issue_comment_url': 'https://api.github.com/repos/bigbigsir/nodeJs/issues/comments{/number}',
      'contents_url': 'https://api.github.com/repos/bigbigsir/nodeJs/contents/{+path}',
      'compare_url': 'https://api.github.com/repos/bigbigsir/nodeJs/compare/{base}...{head}',
      'merges_url': 'https://api.github.com/repos/bigbigsir/nodeJs/merges',
      'archive_url': 'https://api.github.com/repos/bigbigsir/nodeJs/{archive_format}{/ref}',
      'downloads_url': 'https://api.github.com/repos/bigbigsir/nodeJs/downloads',
      'issues_url': 'https://api.github.com/repos/bigbigsir/nodeJs/issues{/number}',
      'pulls_url': 'https://api.github.com/repos/bigbigsir/nodeJs/pulls{/number}',
      'milestones_url': 'https://api.github.com/repos/bigbigsir/nodeJs/milestones{/number}',
      'notifications_url': 'https://api.github.com/repos/bigbigsir/nodeJs/notifications{?since,all,participating}',
      'labels_url': 'https://api.github.com/repos/bigbigsir/nodeJs/labels{/name}',
      'releases_url': 'https://api.github.com/repos/bigbigsir/nodeJs/releases{/id}',
      'deployments_url': 'https://api.github.com/repos/bigbigsir/nodeJs/deployments',
      'created_at': 1548067217,
      'updated_at': '2020-05-28T05:35:26Z',
      'pushed_at': 1590659755,
      'git_url': 'git://github.com/bigbigsir/nodeJs.git',
      'ssh_url': 'git@github.com:bigbigsir/nodeJs.git',
      'clone_url': 'https://github.com/bigbigsir/nodeJs.git',
      'svn_url': 'https://github.com/bigbigsir/nodeJs',
      'homepage': '',
      'size': 75771,
      'stargazers_count': 2,
      'watchers_count': 2,
      'language': 'JavaScript',
      'has_issues': true,
      'has_projects': true,
      'has_downloads': true,
      'has_wiki': true,
      'has_pages': false,
      'forks_count': 0,
      'mirror_url': null,
      'archived': false,
      'disabled': false,
      'open_issues_count': 0,
      'license': null,
      'forks': 0,
      'open_issues': 0,
      'watchers': 2,
      'default_branch': 'master',
      'stargazers': 2,
      'master_branch': 'master'
    },
    'pusher': {
      'name': 'bigbigsir',
      'email': '519628061@qq.com'
    },
    'sender': {
      'login': 'bigbigsir',
      'id': 30718335,
      'node_id': 'MDQ6VXNlcjMwNzE4MzM1',
      'avatar_url': 'https://avatars0.githubusercontent.com/u/30718335?v=4',
      'gravatar_id': '',
      'url': 'https://api.github.com/users/bigbigsir',
      'html_url': 'https://github.com/bigbigsir',
      'followers_url': 'https://api.github.com/users/bigbigsir/followers',
      'following_url': 'https://api.github.com/users/bigbigsir/following{/other_user}',
      'gists_url': 'https://api.github.com/users/bigbigsir/gists{/gist_id}',
      'starred_url': 'https://api.github.com/users/bigbigsir/starred{/owner}{/repo}',
      'subscriptions_url': 'https://api.github.com/users/bigbigsir/subscriptions',
      'organizations_url': 'https://api.github.com/users/bigbigsir/orgs',
      'repos_url': 'https://api.github.com/users/bigbigsir/repos',
      'events_url': 'https://api.github.com/users/bigbigsir/events{/privacy}',
      'received_events_url': 'https://api.github.com/users/bigbigsir/received_events',
      'type': 'User',
      'site_admin': false
    },
    'created': false,
    'deleted': false,
    'forced': false,
    'base_ref': null,
    'compare': 'https://github.com/bigbigsir/nodeJs/compare/1b389bb6a913...b6f60c43e916',
    'commits': [
      {
        'id': 'b6f60c43e9169ccb56350ce5b035c5483761d42c',
        'tree_id': 'b968e486dc0eb584c3c9cbe8e250bdeb0f5f2b37',
        'distinct': true,
        'message': '‘update’',
        'timestamp': '2020-05-28T17:55:48+08:00',
        'url': 'https://github.com/bigbigsir/nodeJs/commit/b6f60c43e9169ccb56350ce5b035c5483761d42c',
        'author': {
          'name': 'emoji',
          'email': '519628061@qq.com',
          'username': 'bigbigsir'
        },
        'committer': {
          'name': 'emoji',
          'email': '519628061@qq.com',
          'username': 'bigbigsir'
        },
        'added': [
          'public/favicon.ico'
        ],
        'removed': [],
        'modified': [
          'public/index.html',
          'routes/util/handels.js'
        ]
      }
    ],
    'head_commit': {
      'id': 'b6f60c43e9169ccb56350ce5b035c5483761d42c',
      'tree_id': 'b968e486dc0eb584c3c9cbe8e250bdeb0f5f2b37',
      'distinct': true,
      'message': '‘update’',
      'timestamp': '2020-05-28T17:55:48+08:00',
      'url': 'https://github.com/bigbigsir/nodeJs/commit/b6f60c43e9169ccb56350ce5b035c5483761d42c',
      'author': {
        'name': 'emoji',
        'email': '519628061@qq.com',
        'username': 'bigbigsir'
      },
      'committer': {
        'name': 'emoji',
        'email': '519628061@qq.com',
        'username': 'bigbigsir'
      },
      'added': [
        'public/favicon.ico'
      ],
      'removed': [],
      'modified': [
        'public/index.html',
        'routes/util/handels.js'
      ]
    }
  }

  function getWebToken () {
    let data = {}
    data = JSON.stringify(data)
    const qid = md5(Date.now() + Math.random() + '')
    const sign = md5(qid + reverseString(data) + token)
    $.ajax({
      type: 'post',
      url: '/common/getWebToken',
      headers: {
        token: token,
        qid: qid,
        sign: sign
      },
      data,
      contentType: 'application/json;charset=UTF-8',
      success ({ data }) {
        token = data
      }
    })
  }

  getWebToken()
  $('#node').on('click', function () {
    //连接服务器,得到代表连接的socket对象
    const socket = io('/socket/webHooks', {
      autoConnect: false,
      reconnection: false,
      query: {
        token: 'cde'
      },
      transportOptions: {
        polling: {
          extraHeaders: {
            token
          }
        }
      }
    })
    const socketEl = document.getElementById('socket')
    socket.connect()
    socket.on('connect', () => {
      $.ajax({
        type: 'post',
        url: '/webHooks/projectNode',
        headers: {
          token,
          'socket-id': socket.id,
          'X-GitHub-Event': 'push',
          'X-Hub-Signature': 'sha1=a071516470b66fb43a3fd28fbc7c7e13d438adf6'
        },
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify(data),
        success (data) {
          if (data.code === '0') {
            // document.getElementById('nodePre').innerText = data.data
          }
        }
      })
      console.log('connect=>', socket.id, socket.connected)
    })
    socket.on('process_stdout', function (data) {
      console.log('process_stdout=>', data)
      socketEl.innerText += data
    })
    socket.on('process_stderr', function (data) {
      console.log('process_stderr=>', data)
      socketEl.innerText += data
    })
    socket.on('process_error', function (data) {
      console.log('process_error=>', data)
      socketEl.innerText += data
    })
    socket.on('process_close', function (data) {
      console.log('process_close=>', data)
      socketEl.innerText += data
    })
    socket.on('error', function (data) {
      console.log('error=>', data)
      socketEl.innerText += data
    })
    socket.on('connect_error', (error) => {
      console.log('connect_error=>', error)
    })
    socket.on('disconnect', (reason) => {
      socket.disconnect()
      console.log('disconnect=>', reason)
    })
  })
  $('#react').on('click', function () {
    const data = {
      ref: 'refs/heads/master'
    }
    const secret = 'e6f2511e790e05e769416bb4d4603d602943d314'
    const sha1 = CryptoJS.HmacSHA1(JSON.stringify(data), secret).toString()

    const socket = io('/socket/webHooks', {
      autoConnect: false,
      reconnection: false,
      query: {
        token: 'cde'
      },
      transportOptions: {
        polling: {
          extraHeaders: {
            'x-clientid': 'abc'
          }
        }
      }
    })
    const socketEl = document.getElementById('socket')
    socket.connect()
    socket.on('connect', (e) => {
      console.log(e)
      $.ajax({
        type: 'post',
        url: '/webHooks/projectReactWeb',
        headers: {
          'socket-id': socket.id,
          'X-GitHub-Event': 'push',
          'X-Hub-Signature': 'sha1=' + sha1
        },
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify(data),
        success (data) {
          if (data.code === '0') {
            // document.getElementById('reactPre').innerText = data.data
          }
        }
      })
      console.log('connect=>', socket.id, socket.connected)
    })
    socket.on('process_stdout', function (data) {
      console.log('process_stdout=>', data)
      socketEl.innerText += data
    })
    socket.on('process_stderr', function (data) {
      console.log('process_stderr=>', data)
      socketEl.innerText += data
    })
    socket.on('process_error', function (data) {
      console.log('process_error=>', data)
      socketEl.innerText += data
    })
    socket.on('process_close', function (data) {
      console.log('process_close=>', data)
      socketEl.innerText += data
    })
    socket.on('error', function (data) {
      console.log('error=>', data)
      socketEl.innerText += data
    })
    socket.on('connect_error', (error) => {
      console.log('connect_error=>', error)
    })
    socket.on('disconnect', (reason) => {
      socket.disconnect()
      console.log('disconnect=>', reason)
    })
  })
</script>
</body>
</html>
